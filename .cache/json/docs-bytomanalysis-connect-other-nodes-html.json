{"data":{"markdownRemark":{"html":"<p>最开始我对于这个问题一直有个疑惑：区块链是一个分布式的网络，那么一个节点启动后，它怎么知道去哪里找别的节点从而加入网络呢？</p>\n<p>看到代码之后，我才明白，原来在代码中硬编码了一些种子地址，这样在启动的时候，可以先通过种子地址加入网络。虽然整个网络是分布式的，但是最开始还是需要一定的中心化。</p>\n<h3 id=\"预编码内容\"><a href=\"#%E9%A2%84%E7%BC%96%E7%A0%81%E5%86%85%E5%AE%B9\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>预编码内容</h3>\n<p>对于配置文件<code class=\"gatsby-code-text\">config.toml</code>，比原的代码中硬编码了配置文件内容：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/config/toml.go#L22-L45\">config/toml.go#L22-L45</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">var</span> defaultConfigTmpl <span class=\"token operator\">=</span> <span class=\"token string\">`# This is a TOML config file.\n# For more information, see https://github.com/toml-lang/toml\nfast_sync = true\ndb_backend = \"leveldb\"\napi_addr = \"0.0.0.0:9888\"\n`</span>\n\n<span class=\"token keyword\">var</span> mainNetConfigTmpl <span class=\"token operator\">=</span> <span class=\"token string\">`chain_id = \"mainnet\"\n[p2p]\nladdr = \"tcp://0.0.0.0:46657\"\nseeds = \"45.79.213.28:46657,198.74.61.131:46657,212.111.41.245:46657,\n47.100.214.154:46657,47.100.109.199:46657,47.100.105.165:46657\"\n`</span>\n\n<span class=\"token keyword\">var</span> testNetConfigTmpl <span class=\"token operator\">=</span> <span class=\"token string\">`chain_id = \"testnet\"\n[p2p]\nladdr = \"tcp://0.0.0.0:46656\"\nseeds = \"47.96.42.1:46656,172.104.224.219:46656,45.118.132.164:46656\"\n`</span>\n\n<span class=\"token keyword\">var</span> soloNetConfigTmpl <span class=\"token operator\">=</span> <span class=\"token string\">`chain_id = \"solonet\"\n[p2p]\nladdr = \"tcp://0.0.0.0:46658\"\nseeds = \"\"\n`</span></code></pre>\n      </div>\n<p>可以看出，对于不同的<code class=\"gatsby-code-text\">chain_id</code>，预设的种子是不同的。</p>\n<p>当然，如果我们自己知道某些节点的地址，也可以在初始化生成<code class=\"gatsby-code-text\">config.toml</code>后，手动修改该文件添加进去。</p>\n<h3 id=\"启动syncmanager\"><a href=\"#%E5%90%AF%E5%8A%A8syncmanager\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>启动<code class=\"gatsby-code-text\">syncManager</code></h3>\n<p>那么，比原在代码中是使用这些种子地址并连接它们的呢？关键在于，连接的代码位于<code class=\"gatsby-code-text\">SyncManager</code>中，所以我们要找到启动<code class=\"gatsby-code-text\">syncManager</code>的地方。</p>\n<p>首先，当我们使用<code class=\"gatsby-code-text\">bytomd node</code>启动后，下面的函数将被调用：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/cmd/bytomd/commands/run_node.go#L41\">cmd/bytomd/commands/run_node.go#L41</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">runNode</span><span class=\"token punctuation\">(</span>cmd <span class=\"token operator\">*</span>cobra<span class=\"token punctuation\">.</span>Command<span class=\"token punctuation\">,</span> args <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Create &amp; start node</span>\n    n <span class=\"token operator\">:=</span> node<span class=\"token punctuation\">.</span><span class=\"token function\">NewNode</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> n<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>这里调用了<code class=\"gatsby-code-text\">n.Start</code>，其中的<code class=\"gatsby-code-text\">Start</code>方法，来自于<code class=\"gatsby-code-text\">Node</code>所嵌入的<code class=\"gatsby-code-text\">cmn.BaseService</code>：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/node/node.go#L39\">node/node.go#L39</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">type</span> Node <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    cmn<span class=\"token punctuation\">.</span>BaseService\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>所以<code class=\"gatsby-code-text\">n.Start</code>对应的是下面这个方法：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/vendor/github.com/tendermint/tmlibs/common/service.go#L97\">vendor/github.com/tendermint/tmlibs/common/service.go#L97</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>bs <span class=\"token operator\">*</span>BaseService<span class=\"token punctuation\">)</span> <span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    err <span class=\"token operator\">:=</span> bs<span class=\"token punctuation\">.</span>impl<span class=\"token punctuation\">.</span><span class=\"token function\">OnStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>在这里，由于<code class=\"gatsby-code-text\">bs.impl</code>对应于<code class=\"gatsby-code-text\">Node</code>，所以将继续调用<code class=\"gatsby-code-text\">Node.OnStart()</code>:</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/node/node.go#L169\">node/node.go#L169</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">*</span>Node<span class=\"token punctuation\">)</span> <span class=\"token function\">OnStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    n<span class=\"token punctuation\">.</span>syncManager<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>可以看到，我们终于走到了调用了<code class=\"gatsby-code-text\">syncManager.Start()</code>的地方。</p>\n<h3 id=\"syncmanager中的处理\"><a href=\"#syncmanager%E4%B8%AD%E7%9A%84%E5%A4%84%E7%90%86\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"gatsby-code-text\">syncManager</code>中的处理</h3>\n<p>然后就是在<code class=\"gatsby-code-text\">syncManager</code>内部的一些处理了。</p>\n<p>它主要是除了从<code class=\"gatsby-code-text\">config.toml</code>中取得种子节点外，还需要把以前连接过并保存在本地的<code class=\"gatsby-code-text\">AddressBook.json</code>中的节点也拿出来连接，这样就算预设的种子节点失败了，也还是有可能连接上网络（部分解决了前面提到的中心化的担忧）。</p>\n<p><code class=\"gatsby-code-text\">syncManager.Start()</code>对应于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/netsync/handle.go#L141\">netsync/handle.go#L141</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">*</span>SyncManager<span class=\"token punctuation\">)</span> <span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">go</span> sm<span class=\"token punctuation\">.</span><span class=\"token function\">netStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>其中<code class=\"gatsby-code-text\">sm.netStart()</code>，对应于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/netsync/handle.go#L121\">netsync/handle.go#L121</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">*</span>SyncManager<span class=\"token punctuation\">)</span> <span class=\"token function\">netStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// If seeds exist, add them to the address book and dial out</span>\n    <span class=\"token keyword\">if</span> sm<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>P2P<span class=\"token punctuation\">.</span>Seeds <span class=\"token operator\">!=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// dial out</span>\n        seeds <span class=\"token operator\">:=</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">Split</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>P2P<span class=\"token punctuation\">.</span>Seeds<span class=\"token punctuation\">,</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> sm<span class=\"token punctuation\">.</span><span class=\"token function\">DialSeeds</span><span class=\"token punctuation\">(</span>seeds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> err\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>其中的<code class=\"gatsby-code-text\">sm.config.P2P.Seeds</code>就对应于<code class=\"gatsby-code-text\">config.toml</code>中的<code class=\"gatsby-code-text\">seeds</code>。关于这两者是怎么对应起来的，会在后面文章中详解。</p>\n<p>紧接着，再通过<code class=\"gatsby-code-text\">sm.DialSeeds(seeds)</code>去连接这些seed，这个方法对应的代码位于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/netsync/handle.go#L229\">netsync/handle.go#L229</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">*</span>SyncManager<span class=\"token punctuation\">)</span> <span class=\"token function\">DialSeeds</span><span class=\"token punctuation\">(</span>seeds <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> sm<span class=\"token punctuation\">.</span>sw<span class=\"token punctuation\">.</span><span class=\"token function\">DialSeeds</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>addrBook<span class=\"token punctuation\">,</span> seeds<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>其实是是调用了<code class=\"gatsby-code-text\">sm.sw.DialSeeds</code>，而<code class=\"gatsby-code-text\">sm.sw</code>是指<code class=\"gatsby-code-text\">Switch</code>。这时可以看到，有一个叫<code class=\"gatsby-code-text\">addrBook</code>的东西参与了进来，它保存了该结点之前成功连接过的节点地址，我们这里暂不多做讨论。</p>\n<p><code class=\"gatsby-code-text\">Switch.DialSeeds</code>对应于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/p2p/switch.go#L311\">p2p/switch.go#L311</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sw <span class=\"token operator\">*</span>Switch<span class=\"token punctuation\">)</span> <span class=\"token function\">DialSeeds</span><span class=\"token punctuation\">(</span>addrBook <span class=\"token operator\">*</span>AddrBook<span class=\"token punctuation\">,</span> seeds <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    perm <span class=\"token operator\">:=</span> rand<span class=\"token punctuation\">.</span><span class=\"token function\">Perm</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>netAddrs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>perm<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n        j <span class=\"token operator\">:=</span> perm<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n        sw<span class=\"token punctuation\">.</span><span class=\"token function\">dialSeed</span><span class=\"token punctuation\">(</span>netAddrs<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n   <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>这里引入了随机数，是为了将发起连接的顺序打乱，这样可以让每个种子都获得公平的连接机会。</p>\n<p><code class=\"gatsby-code-text\">sw.dialSeed(netAddrs[j])</code>对应于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/p2p/switch.go#L342\">p2p/switch.go#L342</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sw <span class=\"token operator\">*</span>Switch<span class=\"token punctuation\">)</span> <span class=\"token function\">dialSeed</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">*</span>NetAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    peer<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> sw<span class=\"token punctuation\">.</span><span class=\"token function\">DialPeerWithAddress</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p><code class=\"gatsby-code-text\">sw.DialPeerWithAddress(addr, false)</code>又对应于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/p2p/switch.go#L351\">p2p/switch.go#L351</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sw <span class=\"token operator\">*</span>Switch<span class=\"token punctuation\">)</span> <span class=\"token function\">DialPeerWithAddress</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">*</span>NetAddress<span class=\"token punctuation\">,</span> persistent <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Peer<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">WithField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"address\"</span><span class=\"token punctuation\">,</span> addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Dialing peer\"</span><span class=\"token punctuation\">)</span>\n    peer<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">newOutboundPeerWithConfig</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> sw<span class=\"token punctuation\">.</span>reactorsByCh<span class=\"token punctuation\">,</span> sw<span class=\"token punctuation\">.</span>chDescs<span class=\"token punctuation\">,</span> sw<span class=\"token punctuation\">.</span>StopPeerForError<span class=\"token punctuation\">,</span> sw<span class=\"token punctuation\">.</span>nodePrivKey<span class=\"token punctuation\">,</span> sw<span class=\"token punctuation\">.</span>peerConfig<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>其中的<code class=\"gatsby-code-text\">persistent</code>参数如果是<code class=\"gatsby-code-text\">true</code>的话，表明这个peer比较重要，在某些情况下如果断开连接后，还会尝试重连。如果<code class=\"gatsby-code-text\">persistent</code>为<code class=\"gatsby-code-text\">false</code>的，就没有这个待遇。</p>\n<p><code class=\"gatsby-code-text\">newOutboundPeerWithConfig</code>对应于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/p2p/peer.go#L69\">p2p/peer.go#L69</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">newOutboundPeerWithConfig</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">*</span>NetAddress<span class=\"token punctuation\">,</span> reactorsByCh <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">]</span>Reactor<span class=\"token punctuation\">,</span> chDescs <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>ChannelDescriptor<span class=\"token punctuation\">,</span> onPeerError <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Peer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ourNodePrivKey crypto<span class=\"token punctuation\">.</span>PrivKeyEd25519<span class=\"token punctuation\">,</span> config <span class=\"token operator\">*</span>PeerConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Peer<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    conn<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">dial</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>继续<code class=\"gatsby-code-text\">dial</code>，加入了超时：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/p2p/peer.go#L284\">p2p/peer.go#L284</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">dial</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">*</span>NetAddress<span class=\"token punctuation\">,</span> config <span class=\"token operator\">*</span>PeerConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>net<span class=\"token punctuation\">.</span>Conn<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    conn<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> addr<span class=\"token punctuation\">.</span><span class=\"token function\">DialTimeout</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>DialTimeout <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> conn<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p><code class=\"gatsby-code-text\">addr.DialTimeout</code>对应于：</p>\n<p><a href=\"https://github.com/freewind/bytom/blob/master/p2p/netaddress.go#L141\">p2p/netaddress.go#L141</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>na <span class=\"token operator\">*</span>NetAddress<span class=\"token punctuation\">)</span> <span class=\"token function\">DialTimeout</span><span class=\"token punctuation\">(</span>timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>net<span class=\"token punctuation\">.</span>Conn<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    conn<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">DialTimeout</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> na<span class=\"token punctuation\">.</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> conn<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>终于到了<code class=\"gatsby-code-text\">net</code>包的调用，开始真正去连接这个种子节点了，到这里，我们可以认为这个问题解决了。</p>\n<hr>\n<p>如果你觉得这些文章对你非常有用，控制不住想打赏作者，可以有以下选择：</p>\n<ol>\n<li>BTM: <code class=\"gatsby-code-text\">0x6bcCfb7265d4aB0C1a71F7d19b9E581cae73D777</code></li>\n<li>BTC: <code class=\"gatsby-code-text\">1Af2Q23Y1kqgtgbryzjS7RxrnEmyvYuX4b</code></li>\n<li>ETH: <code class=\"gatsby-code-text\">0x6bcCfb7265d4aB0C1a71F7d19b9E581cae73D777</code></li>\n</ol>\n<p>多少请随意，心意最重要，我们一起努力吧！</p>","frontmatter":{"title":"连接别的节点","next":null,"prev":null},"fields":{"path":null,"slug":"docs/bytomanalysis-connect-other-nodes.html"}}},"pathContext":{"slug":"docs/bytomanalysis-connect-other-nodes.html"}}