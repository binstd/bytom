{"data":{"markdownRemark":{"html":"<p>在前面几篇中，我们做了足够了准备，现在终于可以试一试转帐功能了！</p>\n<p>这里的转帐最好使用<code class=\"gatsby-code-text\">solonet</code>，再按前一篇文章的办法修改代码后产生单机测试币，然后再试。在此之前，如果需要的话，请先备份好你之前的帐户，然后删除（或重命名）你的数据目录，再使用<code class=\"gatsby-code-text\">bytomd init --chain_id=solonet</code>重新初始化。</p>\n<p>下面是我通过dashboard进行的转帐操作，在操作之前，我先建立了两个帐户，然后把钱从一个帐户转到另一个帐户的地址中：</p>\n<p>新建一个交易，填上把哪个帐户的哪种资产转到某个地址上。可以看到还要消耗一定的gas：</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bytom-transaction1-c815d4f0f71773829ab93f26b0fdac38-c998b.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 102.03748981255094%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAABmElEQVQ4y5WU226CQBCGeZEGPGFVEKuN9nDRx+u7VdtLr73EpEltBZcFlunO4m45bBEnmWiW8XPm/3cwbG8Fpu2B2ZnAZvMBxUiSBHzfh8PhAIQQcZZlWWMa7t0TjKcrsHoTWJ+BCMKglMLe3wNjTGSbMKYcOBzNwew5CpimqQIjVIa+q/xcPjfc2SM43gNY/TJQ/gCBCI7jWHVaTFmrgGN3Cd78GboDtwaUY+dAqgXisxJw5Nxz/VwwuxMtMAxDkSSKtEDMEnA4XogOB7czeFu/14DYASERRJQqY3RaKqDDNVwsX8DmxhSBGFV3m66LAlrc3RtrBJbGZYShhljIWB3CdMBO3wWZOg1x3CAIRB6PR5FFx7VA7E4HzIQpJ7ElOiOwruZyEzD/nihgdeSrgLnDqVrD/3TMANoDCU3g6ydUWoYnUvqDqn5il5uAWBRFFM61petT/GwNjGkstkReoVb3sFnDBMIg5F1Gwhg81+1ycaKLLl/aEHZNh00QjB0J4HW3hW3wncvStsNqqFcbH/kz5i8O9tfAL516jmf59AhBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"bytom-transaction1\"\n        title=\"\"\n        src=\"/static/bytom-transaction1-c815d4f0f71773829ab93f26b0fdac38-acf85.png\"\n        srcset=\"/static/bytom-transaction1-c815d4f0f71773829ab93f26b0fdac38-c1418.png 210w,\n/static/bytom-transaction1-c815d4f0f71773829ab93f26b0fdac38-5d5d8.png 420w,\n/static/bytom-transaction1-c815d4f0f71773829ab93f26b0fdac38-acf85.png 840w,\n/static/bytom-transaction1-c815d4f0f71773829ab93f26b0fdac38-c998b.png 1227w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>（上图为图1）</p>\n<p>转帐成功后，如下：</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bytom-transaction2-589000e82808cdc41a92f1f1053ab397-79b99.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 77.41228070175438%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAC30lEQVQ4y2VT2U5UQRS8fwCaiDwYtiDgOCyDKIsKMSQYX/wCv0o0MQwIauK7X+APmPgBJi6EZZjlrt199ynr9NwxMdzkZKa7T1efc6rK2d59ga2dPaxu7GB8ch4nnz5DG4MkTWG/fr/66V+Loizt2TevjVffv+JL6zecxvo2FpbXMVtr4Ob4NA6PP9okrTWSJIWJYxgTI04SZFlm9+S/RJ7nKPICfmzQ0hEC3nFmV9Yx01jH1N1FjIxNoHl0YgE73R5UGEIxSVXgRVEgZeWxfcRg+Kk0gckzpNx3ltae4tHjXUzM1jF6exIH7z/YJM/1kPNykuVQvOwHoW3RSJVlYXNkrZgTZoPxGFbt1FY2cI8tT80tEXAKB2/fAZEP3bpAfHUJfXluQ12cwXBPt87tmanCnnNPctUpZ1hvbP4H2Hy9D7B81/OgogghKwuCAIZtF6wuZrVaKXvWF1JIjmcUfLadnP4i4OoW5uprmJ4fAr4RThGEkWXSxAkiAvh+YGcobcV8UM5KGQFbDpIYooX47A+c+cWHWGBMS4XjQ0CS4vmDgRPQJdgVSSp5KyKAqmYoICEfcLPErhMBFDKk3ZmFZYyQlOY+AXUI7+Icme9Cd9oIW5fwzs8Q97pQ3Ta02+WZZ9dB+wq610EecO4/f8DZ3N7Ds72XFPdz3GCFB81jgC8G7TYUL4SdDqJuB8ZzkfKScV2CDvbzKESpIvh8QML4PpzFB09wn0zXqEcLeDSQTZeyiSlokU2cUmMUsbSYc24pZ5lVLrFy4QhSnoq7nDszNUhI2yO3Jgg4EHZAlrPKJREZ9fm6iFo0qcmoEJKJBsl+QKf0+Yi4y5mkQyRmFlYwOkZhHw4AhVnxtFLahjjDVA7RlXvEMQlJUUYjMpKnBLD+D3BgvarlXg8RpSMXBVyqk6qG1tOsfPiFrDjk3BMq4hrgcIYuZZLzYkoxS1UBfV0WJWKxXpHbHFlrqXBoPeb/Bcr06hS6zTsiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"bytom-transaction2\"\n        title=\"\"\n        src=\"/static/bytom-transaction2-589000e82808cdc41a92f1f1053ab397-acf85.png\"\n        srcset=\"/static/bytom-transaction2-589000e82808cdc41a92f1f1053ab397-c1418.png 210w,\n/static/bytom-transaction2-589000e82808cdc41a92f1f1053ab397-5d5d8.png 420w,\n/static/bytom-transaction2-589000e82808cdc41a92f1f1053ab397-acf85.png 840w,\n/static/bytom-transaction2-589000e82808cdc41a92f1f1053ab397-79b99.png 912w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>（上图为图2）</p>\n<p>我们看一下这个交易的详细信息，由于太长，截成了两个图：</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bytom-transaction-detail1-63c11e60a5e582dd408d2a2bdea3424c-8f54b.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 107.85388127853881%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAACNElEQVQ4y5VViXKFIAz0//+0fR4gIKJAmg3GasfXaZ3ZcjxYks3Rzu2JxrjQ8BrIhUDeM0KD4/meM9Va36Jc5vyHur7vaRxHcs6RtVYwzzPNvJ51D2uGY1g7yxpj23OyP1pDH9NI3TQZ6l89pZRo2zaB814eMfyb7KWNlmUhEzwlXuvZNa40eH6YPcSe47Fb15XiEinnQvqta6KZLfDOn3tw3bM816+UQnNaaS353GMLJ+r7gbXzol9g7WZ2A/vGGFkH0daTZWt0DTh+0MDt4y7OdANcM5ZijO2iHHRyGAdBrrrJ/NAPBJBBEBa+u8j9DkT4ECXM4frCEgQGxsiSpLQ1bN8opbZ7VwkQZbCCLLNGE1u777uki50RZS9zkC4cgBgxRplrOoEYaByFCdlkLEBkxkmIEZSVo4Yxs/DlES0HS/1BCA3U7MDWgBDubdveElbkaK7dUO/QqHcIAFIHADl01ErR/f+g+/x8SRJ7iWirEDyCtTvm/0Fz+ahFuAwtRTt2/TfAvfqkIfIHGoAIyYzoabrcEO94ahoIoFgopcWElhMcL+/7xYIjqrXWW9k9dp4roeYiPuTgMJqW1FtLajx4JXr6TsLT5EMbaCjJu+dfLXproW6gu0AbaORZW4hcL6L/iTAcib2za61SihQ+rHy+VM8q+dm180l4RBkNNV+iDNLrqBr/KShKCJe1OWiD0FFLcpNuU964zCUGk9HO8f9BNVzivcPEW7eJYgAI8gFJN777BZ4xukGhf0RjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"bytom-transaction-detail1\"\n        title=\"\"\n        src=\"/static/bytom-transaction-detail1-63c11e60a5e582dd408d2a2bdea3424c-acf85.png\"\n        srcset=\"/static/bytom-transaction-detail1-63c11e60a5e582dd408d2a2bdea3424c-c1418.png 210w,\n/static/bytom-transaction-detail1-63c11e60a5e582dd408d2a2bdea3424c-5d5d8.png 420w,\n/static/bytom-transaction-detail1-63c11e60a5e582dd408d2a2bdea3424c-acf85.png 840w,\n/static/bytom-transaction-detail1-63c11e60a5e582dd408d2a2bdea3424c-8f54b.png 1095w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bytom-transaction-detail2-9eac917a8af478519aa2b8bc6ab81d19-a62e3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 114.40520446096653%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3klEQVQ4y5VV2XKDMAzk/380fWmb4PtC1crYAWJI6pkdgoG1pNUq0+32RdZagda6/3bOXaK9t4UxhqacM2GllMg7TzEm0sZSCIF8iIzAv/nqQwXuY6RlWXaoHJkmfIiV+QaEORd5gAOe1yMylVKoMJGgVFI8m3A6luVwjTYUedNapOVPgUhBuAwJYyVUsxJCRNhfLuUUx5Q7YVwJI6eODbz8e3+QQrTxWUPsH9dLDVmPTtgWNkFmOG1EO4pkhCZsJ8SNZXUzR2K5LWqdlo8JX1KGKCCEgi3dqxRPCVvbzA+um1KiMtJFP6J2glixU3aLMojQey/djhoadD2TosE1RwtYbpePagi7VDLXraf4qo3pZFpEsvLeOztKyjgBkWITqUIQWPKI7hS5LzugHODoKeMDWA8fNDc4v3GIr0Dqfg3iUmVJR3ov9yFwRAjnw2Gg8kxaaWkbKL1LkRE3aI6CuhXlNUK3Fh0PIVC127Lz7lVP9vGFE7cLkX3/3OnBwwKkODDGsZePK2+9LAPWe9lsRO3kf1mvja8ABcV6SaKDop+SlWUwYGceWRAlptqHSUTZ492w2ImC4dpUhuXgDLGe4L31AKmhuCMl6TG3ji1jrChtVmIj/4K+CzQColMc0B8QTRJTE2XcIAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"bytom-transaction-detail2\"\n        title=\"\"\n        src=\"/static/bytom-transaction-detail2-9eac917a8af478519aa2b8bc6ab81d19-acf85.png\"\n        srcset=\"/static/bytom-transaction-detail2-9eac917a8af478519aa2b8bc6ab81d19-c1418.png 210w,\n/static/bytom-transaction-detail2-9eac917a8af478519aa2b8bc6ab81d19-5d5d8.png 420w,\n/static/bytom-transaction-detail2-9eac917a8af478519aa2b8bc6ab81d19-acf85.png 840w,\n/static/bytom-transaction-detail2-9eac917a8af478519aa2b8bc6ab81d19-a62e3.png 1076w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>（上面两图合称为图3）</p>\n<p>我们今天（以及往后的几天）就是把这一块流程搞清楚。</p>\n<p>由于上面展示的操作还是有点多的，所以我们还是按之前的套路，先把它分解成多个小问题，一一解决：</p>\n<ol>\n<li>图1中，转帐界面是如何把转帐数据提交到后台的?</li>\n<li>图1中，后台是如何接收到转帐数据并执行转帐操作的？</li>\n<li>图2中，前台是如何拿到后台的数据并展示出来的？</li>\n<li>图3中，前台是如何拿到后台的数据并展示出来的？</li>\n</ol>\n<p>今天的文章，我们主要是研究前两个问题，即跟图1相关的逻辑。</p>\n<h2 id=\"图1中，转帐表单是如何把转帐数据提交到后台的\"><a href=\"#%E5%9B%BE1%E4%B8%AD%EF%BC%8C%E8%BD%AC%E5%B8%90%E8%A1%A8%E5%8D%95%E6%98%AF%E5%A6%82%E4%BD%95%E6%8A%8A%E8%BD%AC%E5%B8%90%E6%95%B0%E6%8D%AE%E6%8F%90%E4%BA%A4%E5%88%B0%E5%90%8E%E5%8F%B0%E7%9A%84\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>图1中，转帐表单是如何把转帐数据提交到后台的?</h2>\n<p>由于是前端，所以我们要去从前端的代码库中寻找。通过搜索“简单交易”这个词，我们很快定位到下面这块代码：</p>\n<p><a href=\"https://github.com/freewind/bytom-dashboard-v1.0.0/blob/master/src/features/transactions/components/New/New.jsx#L275-L480\">src/features/transactions/components/New/New.jsx#L275-L480</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\">    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>FormContainer</span> <span class=\"token attr-name\">onSubmit</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token function\">handleSubmit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>submitWithValidation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token comment\">// ...</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>FormContainer</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<p>由于上面的代码实在太长太细节，全是一些jsx用于生成表单的代码，我们就跳过算了，有兴趣的同学可以自行看细节。我们需要关注的是，当我们单击了“提交交易”的按钮以后，<code class=\"gatsby-code-text\">this.submitWithValidation</code>会被调用，而它对应的代码是：</p>\n<p><a href=\"https://github.com/freewind/bytom-dashboard-v1.0.0/blob/master/src/features/transactions/components/New/New.jsx#L159-L177\">src/features/transactions/components/New/New.jsx#L159-L177</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\">  <span class=\"token function\">submitWithValidation</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">submitForm</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// ...</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>通常我们应该会在这个函数里找到一些线索，发现数据会提交到后台哪个接口。但是这次却好像没有有用的信息，只有一个来自于<code class=\"gatsby-code-text\">props</code>的看起来非常通用的<code class=\"gatsby-code-text\">submitForm</code>。看来需要多找找线索。</p>\n<p>好在很快在同一个文件的最后面，看到了用于把React组件与Redux连接起来的代码，非常有用：</p>\n<p><a href=\"https://github.com/freewind/bytom-dashboard-v1.0.0/blob/master/src/features/transactions/components/New/New.jsx#L515-L572\">src/features/transactions/components/New/New.jsx#L515-L572</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> BaseNew<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token operator\">...</span>BaseNew<span class=\"token punctuation\">.</span><span class=\"token function\">mapDispatchToProps</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transaction'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Form<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<p>我把不太关注的内容都省略了，需要关注的是<code class=\"gatsby-code-text\">BaseNew.mapDispatchToProps(&#39;transaction&#39;)(dispatch)</code>这一行。</p>\n<p>为什么要关注<code class=\"gatsby-code-text\">mapDispatchToProps</code>这个方法呢？这是因为当我们点击了表单中的提交按钮后，不论中间怎么操作，最后一定要调用<code class=\"gatsby-code-text\">dispatch</code>来处理某个action。而在前面看到，点击“提交交易”后，执行的是<code class=\"gatsby-code-text\">this.props.submitForm</code>，通过<code class=\"gatsby-code-text\">this.props.</code>可以看出，这个<code class=\"gatsby-code-text\">submitForm</code>是从外部传进来的，而<code class=\"gatsby-code-text\">mapDispatchToPros</code>就是把dispatch操作映射在<code class=\"gatsby-code-text\">props</code>上，让<code class=\"gatsby-code-text\">props</code>中有我们需要的函数。所以如果我们不能从其它地方看到明显的线索的时候，应该考虑去看看这个。</p>\n<p>而<code class=\"gatsby-code-text\">BaseNew.mapDispatchToProps</code>是来自于<code class=\"gatsby-code-text\">BaseNew</code>，我们又找到了相应的代码：</p>\n<p><a href=\"https://github.com/freewind/bytom-dashboard-v1.0.0/blob/master/src/features/shared/components/BaseNew.jsx#L9-L16\">src/features/shared/components/BaseNew.jsx#L9-L16</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">import</span> actions <span class=\"token keyword\">from</span> <span class=\"token string\">'actions'</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapDispatchToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  submitForm<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>actions<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">submitForm</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>actions<span class=\"token punctuation\">.</span>tutorial<span class=\"token punctuation\">.</span><span class=\"token function\">submitTutorialForm</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> resp\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<p>果然在里面找到了<code class=\"gatsby-code-text\">submitForm</code>的定义。在里面第一个<code class=\"gatsby-code-text\">dispatch</code>处，传入了参数<code class=\"gatsby-code-text\">actions[type].submitForm(data)</code>，这里的<code class=\"gatsby-code-text\">type</code>应该是<code class=\"gatsby-code-text\">transaction</code>，而<code class=\"gatsby-code-text\">actions</code>应该是之前某处定义的各种action的集合。</p>\n<p>根据<code class=\"gatsby-code-text\">import actions from &#39;actions&#39;</code>，我们发现<code class=\"gatsby-code-text\">from</code>后面的<code class=\"gatsby-code-text\">&#39;actions&#39;</code>不是相对路径，那么它对应的就是js的源代码根目录<code class=\"gatsby-code-text\">src</code>下的某个文件，比如<code class=\"gatsby-code-text\">actions.js</code>。</p>\n<p>找到后打开一看，里面果然有<code class=\"gatsby-code-text\">transaction</code>：</p>\n<p><a href=\"https://github.com/freewind/bytom-dashboard-v1.0.0/blob/master/src/actions.js#L15-L29\">src/actions.js#L15-L29</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> actions <span class=\"token keyword\">as</span> transaction <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'features/transactions'</span>\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">const</span> actions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  transaction<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>我们继续进入<code class=\"gatsby-code-text\">features/transactions/</code>探索，很快找到：</p>\n<p><a href=\"https://github.com/freewind/bytom-dashboard-v1.0.0/blob/master/src/features/transactions/actions.js#L100-L200\">src/features/transactions/actions.js#L100-L200</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\">form<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">submitForm</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>formParams<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// 2.</span>\n  <span class=\"token keyword\">const</span> buildPromise <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/build-transaction'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>actions<span class=\"token punctuation\">:</span> processed<span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">signAndSubmitTransaction</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>transaction<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 4. </span>\n    <span class=\"token keyword\">return</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/sign-transaction'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      password<span class=\"token punctuation\">,</span>\n      transaction\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resp <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'fail'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>msg<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">const</span> rawTransaction <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>rawTransaction\n      <span class=\"token comment\">// 5. </span>\n      <span class=\"token keyword\">return</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/submit-transaction'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>rawTransaction<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>dealSignSubmitResp<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>formParams<span class=\"token punctuation\">.</span>submitAction <span class=\"token operator\">==</span> <span class=\"token string\">'submit'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1. </span>\n    <span class=\"token keyword\">return</span> buildPromise\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'fail'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>msg<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 3.</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">signAndSubmitTransaction</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span> formParams<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>上面的代码经过了我的简化，其实它本来是有很多分支的（因为表单中除了“简单交易”还有“高级交易”等情况）。即使如此，也可以看出来这个过程还是比较复杂的，经过了好几次的后台接口访问：</p>\n<ol>\n<li>第1处代码就是对应我们“简单交易”的情况，它会调用<code class=\"gatsby-code-text\">buildPromise</code>，这里面应该包括了对后台的访问</li>\n<li>第2处就是<code class=\"gatsby-code-text\">buildPromise</code>的定义，可以看到会访问<code class=\"gatsby-code-text\">/build-transaction</code></li>\n<li>第3处是如果前一个访问是正常的，那么会继续调用<code class=\"gatsby-code-text\">signAndSubmitTransaction</code></li>\n<li>第4处就进入到<code class=\"gatsby-code-text\">signAndSubmitTransaction</code>内部了，可以看到，它会访问一个新的接口<code class=\"gatsby-code-text\">/sign-transaction</code></li>\n<li>第5处是在前一个正常的情况下，进行最后的提交，访问接口<code class=\"gatsby-code-text\">/submit-transaction</code>。后面的<code class=\"gatsby-code-text\">dealSignSubmitResp</code>是一些对前端的操作，所以就不看它了</li>\n</ol>\n<p>可以看到，这一个表单的提交，在内部对应着好几个接口的访问，每个提交的数据也不一样，代码跟踪起来不太方便。但是好在只要我们知道了这一条主线，那么寻找其它的信息就会简单一些。不过我们也没有必要执着于全部从源代码中找到答案，因为我们的目的并不是学习React/Redux，而是理解比原的逻辑，所以我们可以借助别的工具（比如Chrome的Developer Tools），来捕获请求的数据，从而推理出逻辑。</p>\n<p>我已经从Chrome的开发工具中取得了前端向下面几个接口发送的数据：</p>\n<ul>\n<li><code class=\"gatsby-code-text\">/build-transaction</code> </li>\n<li><code class=\"gatsby-code-text\">/sign-transaction</code></li>\n<li><code class=\"gatsby-code-text\">/submit-transaction</code></li>\n</ul>\n<p>但是由于我们在这个小问题中，关注的重点是前端如何把数据提交给后台的，所以对于这里提交的数据的意义暂时不讨论，留待下个小问题中一一解答。</p>\n<h2 id=\"图1中，后台是如何接收到转帐数据并执行转帐操作的？\"><a href=\"#%E5%9B%BE1%E4%B8%AD%EF%BC%8C%E5%90%8E%E5%8F%B0%E6%98%AF%E5%A6%82%E4%BD%95%E6%8E%A5%E6%94%B6%E5%88%B0%E8%BD%AC%E5%B8%90%E6%95%B0%E6%8D%AE%E5%B9%B6%E6%89%A7%E8%A1%8C%E8%BD%AC%E5%B8%90%E6%93%8D%E4%BD%9C%E7%9A%84%EF%BC%9F\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>图1中，后台是如何接收到转帐数据并执行转帐操作的？</h2>\n<p>由于在图1中前端一共访问了3个不同的后端接口，所以在这里我们就需要依次分开讨论。</p>\n<h3 id=\"build-transaction\"><a href=\"#build-transaction\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"gatsby-code-text\">/build-transaction</code></h3>\n<p>下面是我通过Chrome的开发工具捕获的数据，看起来还比较多：</p>\n<p><code class=\"gatsby-code-text\">/build-transaction</code></p>\n<h4 id=\"提交的数据：\"><a href=\"#%E6%8F%90%E4%BA%A4%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%9A\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>提交的数据：</h4>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsxon\"><code class=\"gatsby-code-jsxon\">{\n    &quot;actions&quot;: [{\n        &quot;amount&quot;: 437400,\n        &quot;type&quot;: &quot;spend_account&quot;,\n        &quot;receiver&quot;: null,\n        &quot;account_alias&quot;: &quot;freewind&quot;,\n        &quot;account_id&quot;: &quot;&quot;,\n        &quot;asset_alias&quot;: &quot;BTM&quot;,\n        &quot;reference_data&quot;: null\n    }, {\n        &quot;amount&quot;: 23400000000,\n        &quot;type&quot;: &quot;spend_account&quot;,\n        &quot;receiver&quot;: null,\n        &quot;account_alias&quot;: &quot;freewind&quot;,\n        &quot;account_id&quot;: &quot;&quot;,\n        &quot;asset_alias&quot;: &quot;BTM&quot;,\n        &quot;asset_id&quot;: &quot;&quot;,\n        &quot;reference_data&quot;: null\n    }, {\n        &quot;address&quot;: &quot;sm1qe4z3ava34wv5njdgekcgdlrckc95gnljazezva&quot;,\n        &quot;amount&quot;: 23400000000,\n        &quot;type&quot;: &quot;control_address&quot;,\n        &quot;receiver&quot;: null,\n        &quot;asset_alias&quot;: &quot;BTM&quot;,\n        &quot;asset_id&quot;: &quot;&quot;,\n        &quot;reference_data&quot;: null\n    }]\n}</code></pre>\n      </div>\n<p>可以看到前端向<code class=\"gatsby-code-text\">/build-transaction</code>发送的数据包含了三个元素，其中前两个是来源帐户的信息，第三个是目的帐户地址。这三个元素都包含一个叫<code class=\"gatsby-code-text\">amount</code>的key，它的值对应的是相应资产的数量，如果是<code class=\"gatsby-code-text\">BTM</code>的话，这个数字就需要从右向左数8位，再加上一个小数点。也就是说，第一个amount对应的是<code class=\"gatsby-code-text\">0.00437400</code>个BTM，第二个是<code class=\"gatsby-code-text\">234.00000000</code>，第三个是<code class=\"gatsby-code-text\">234.00000000</code>。</p>\n<p>第一个元素对应的费用是gas，也就是图1中显示出来的估算的手续费。第二个是要从相应帐户中转出<code class=\"gatsby-code-text\">234</code>个BTM，第三个是要转入<code class=\"gatsby-code-text\">234</code>个BTM。</p>\n<p>另外，前两个的<code class=\"gatsby-code-text\">type</code>是<code class=\"gatsby-code-text\">spend_account</code>，表明了是帐户，但是<code class=\"gatsby-code-text\">spend</code>是什么意思目前还不清楚（TODO）；第三个是<code class=\"gatsby-code-text\">control_address</code>，表示是一个地址。</p>\n<p>通过这些数据，比原的后台就知道该怎么做了。</p>\n<h4 id=\"得到的回应：\"><a href=\"#%E5%BE%97%E5%88%B0%E7%9A%84%E5%9B%9E%E5%BA%94%EF%BC%9A\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>得到的回应：</h4>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsxon\"><code class=\"gatsby-code-jsxon\">{\n    &quot;status&quot;: &quot;success&quot;,\n    &quot;data&quot;: {\n        &quot;raw_transaction&quot;: &quot;070100010161015f643bef0936443042ccb1e94213\n        ed52af72488088702d88e7fc3580359a19a522ffffffffffffffffffffffff\n        ffffffffffffffffffffffffffffffffffffffff8099c4d599010001160014\n        108c5ba0934951a12755523f8a1fe42a6c24342f010002013dffffffffffff\n        ffffffffffffffffffffffffffffffffffffffffffffffffffffe8ebaabf42\n        01160014b111c8114dc7ee02050598022b46855fd482d27300013dffffffff\n        ffffffffffffffffffffffffffffffffffffffffffffffffffffffff80d4fe\n        955701160014cd451eb3b1ab9949c9a8cdb086fc78b60b444ff200&quot;,\n        &quot;signing_instructions&quot;: [{\n            &quot;position&quot;: 0,\n            &quot;witness_components&quot;: [{\n                &quot;type&quot;: &quot;raw_tx_signature&quot;,\n                &quot;quorum&quot;: 1,\n                &quot;keys&quot;: [{\n                    &quot;xpub&quot;: &quot;f98b3a39b4eef67707cac85240ef07235c990301b\n                    2e0658001545bdb7fde3a21363a23682a1dfbb727dec756562\n                    4812c314ca9f31a7f7374101e0247d05cb248&quot;,\n                    &quot;derivation_path&quot;: [&quot;010100000000000000&quot;, &quot;0100000000000000&quot;]\n                }],\n                &quot;signatures&quot;: null\n            }, {\n                &quot;type&quot;: &quot;data&quot;,\n                &quot;value&quot;: &quot;b826dcccff76d19d097ca207e053e67d67e3da3a90896ae9fa2d984c6f36d16c&quot;\n            }]\n        }],\n        &quot;allow_additional_actions&quot;: false\n    }\n}</code></pre>\n      </div>\n<p>这个回应信息是什么意思呢？我们现在开始研究。</p>\n<p>我们在比原的后端代码库中，通过查找<code class=\"gatsby-code-text\">/build-transaction</code>，很快找到了它的定义处：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/api.go#L164-L244\">api/api.go#L164-L244</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">*</span>API<span class=\"token punctuation\">)</span> <span class=\"token function\">buildHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token keyword\">if</span> a<span class=\"token punctuation\">.</span>wallet <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n        m<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/build-transaction\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">jsonHandler</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>可以看到它对就的方法是<code class=\"gatsby-code-text\">a.build</code>，其代码为：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/transact.go#L167-L176\">api/transact.go#L167-L176</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">*</span>API<span class=\"token punctuation\">)</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> buildReqs <span class=\"token operator\">*</span>BuildRequest<span class=\"token punctuation\">)</span> Response <span class=\"token punctuation\">{</span>\n    subctx <span class=\"token operator\">:=</span> reqid<span class=\"token punctuation\">.</span><span class=\"token function\">NewSubContext</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> reqid<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    tmpl<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">buildSingle</span><span class=\"token punctuation\">(</span>subctx<span class=\"token punctuation\">,</span> buildReqs<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">NewErrorResponse</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token function\">NewSuccessResponse</span><span class=\"token punctuation\">(</span>tmpl<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>其中的<code class=\"gatsby-code-text\">buildReqs</code>就对应着前端提交过来的参数，只不过被<code class=\"gatsby-code-text\">jsonHandler</code>自动转成了Go代码。其中<code class=\"gatsby-code-text\">BuildRequest</code>是这样定义的：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/request.go#L21-L26\">api/request.go#L21-L26</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">type</span> BuildRequest <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    Tx        <span class=\"token operator\">*</span>types<span class=\"token punctuation\">.</span>TxData            <span class=\"token string\">`json:\"base_transaction\"`</span>\n    Actions   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token string\">`json:\"actions\"`</span>\n    TTL       json<span class=\"token punctuation\">.</span>Duration            <span class=\"token string\">`json:\"ttl\"`</span>\n    TimeRange <span class=\"token builtin\">uint64</span>                   <span class=\"token string\">`json:\"time_range\"`</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>可以看出来有一些字段比如<code class=\"gatsby-code-text\">base_transaction</code>, <code class=\"gatsby-code-text\">ttl</code>, <code class=\"gatsby-code-text\">time_range</code>等在本例中并没有提交上来，它们应该是可选的。</p>\n<p>继续看<code class=\"gatsby-code-text\">a.buildSingle</code>：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/transact.go#L101-L164\">api/transact.go#L101-L164</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">*</span>API<span class=\"token punctuation\">)</span> <span class=\"token function\">buildSingle</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> req <span class=\"token operator\">*</span>BuildRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>txbuilder<span class=\"token punctuation\">.</span>Template<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1.</span>\n    err <span class=\"token operator\">:=</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">filterAliases</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token comment\">// 2.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token function\">onlyHaveSpendActions</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"transaction only contain spend actions, didn't have output actions\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 3.</span>\n    reqActions<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">mergeActions</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token comment\">// 4. </span>\n    actions <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>txbuilder<span class=\"token punctuation\">.</span>Action<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>reqActions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> act <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> reqActions <span class=\"token punctuation\">{</span>\n        typ<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> act<span class=\"token punctuation\">[</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n        decoder<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">actionDecoder</span><span class=\"token punctuation\">(</span>typ<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n        b<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> json<span class=\"token punctuation\">.</span><span class=\"token function\">Marshal</span><span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n        action<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">decoder</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n        actions <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>actions<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 5. </span>\n    ttl <span class=\"token operator\">:=</span> req<span class=\"token punctuation\">.</span>TTL<span class=\"token punctuation\">.</span>Duration\n    <span class=\"token keyword\">if</span> ttl <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        ttl <span class=\"token operator\">=</span> defaultTxTTL\n    <span class=\"token punctuation\">}</span>\n    maxTime <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>ttl<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 6. </span>\n    tpl<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> txbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>Tx<span class=\"token punctuation\">,</span> actions<span class=\"token punctuation\">,</span> maxTime<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>TimeRange<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token keyword\">return</span> tpl<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>这段代码内容还是比较多的，但总体基本上还是对参数进行验证、补全和转换，然后交给后面的方法处理。我分成了多块，依次讲解大意：</p>\n<ol>\n<li>第1处的<code class=\"gatsby-code-text\">filterAliases</code>主要是对传进来的参数进行验证和补全。比如像account和asset，一般都有id和alias这两个属性，如果只提交了alias而没有提交id的话，则<code class=\"gatsby-code-text\">filterAliases</code>就会从数据库或者缓存中查找到相应的<code class=\"gatsby-code-text\">id</code>补全。如果过程中出了错，比如alias不存在，则报错返回</li>\n<li>第2处的<code class=\"gatsby-code-text\">onlyHaveSpendActions</code>是检查如果这个交易中，只存在资金来源方，而没有资金目标方，显示是不对的，报错返回</li>\n<li>第3处的<code class=\"gatsby-code-text\">mergeActions</code>是把请求数据中的<code class=\"gatsby-code-text\">spend_account</code>进行分组累加，把相同account的相同asset的数量累加到一起</li>\n<li>第4处的代码看着挺多，实际上只是把刚才处理过的请求数据由JSON转换成相应的Go对象。在<code class=\"gatsby-code-text\">actionDecoder(typ)</code>里通过手动比较<code class=\"gatsby-code-text\">type</code>的值返回相应的Decoder</li>\n<li>第5处的<code class=\"gatsby-code-text\">ttl</code>是指<code class=\"gatsby-code-text\">Time To Live</code>，指的这个请求的存活时间，如果没指明的话（本例就没有），则设为默认值5分钟</li>\n<li>第6处就是转交给<code class=\"gatsby-code-text\">txbuilder.Build</code>继续处理</li>\n</ol>\n<p>在这几处里提到的方法和函数的代码我就不贴出来了，因为基本上都是一些针对map的低级操作，大片大片的看着很累，实际上没做多少事。这种类型的代码反复出现，在别的语言中（甚至Java)都可以抽出来很多工具方法，但是在Go里由于语言特性（缺少泛型，麻烦的错误处理），似乎不是很容易。看一眼广大Go程序员的期盼：</p>\n<p><a href=\"https://github.com/golang/go/issues/15292\">https://github.com/golang/go/issues/15292</a></p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/go-generic-cd179ef006978eebe920f8438c978775-ba4c4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 55.52699228791774%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+UlEQVQoz1VTR5LbMBDk8/0Hf8A/2PLBX9hQJSuta1ciQYIgmMUc1O6BJAeUumZEcBo9PaD3cT7hefOG3f6A89nH/nCEHyhsd3uXf36e3N52t8Px/RcOx3fmB2w2W/zc7mASi7wokeUF1nWF981/wpftV5xjhSzNkdgUaZY7ZHdIkfyfpgnjON4xYWBclgXX69WRyfLSKkPRlm6z7Xr0w4C+HzAMt6Jpml0cSbYsK5b1L9b1ipmEsjfPi4P34+k73p5f0JLEiqKyQlFdkOYlGh4wk2Tii+MfzBh4SMcDBdWlQcyupKZuWnhd11HNQA9yhJFGpGMH7aD5LHK5MQY6NojjxNnSsFiWtMufg1OI+xKvpPhGoFmcIDIZlLZQEfM45bACN7CSXXRUL0LEz0cUP72HoQmN9/0AAQtUGCIgyUnXOOsSflzB5C2qukbBiQqapkFZ1bgwFmXJvHJD8x6y0zRDSKLYWMYIgWKuqZaKo0jBsF1rLX3OOPWEFiSsSWmBQc4rU5FQhucIZVo2pcLQsFAINMlCtpmwIEbItrVWzmPtK7atHZGll3KlWs5hcpOeb4RyBZqWp4xUO1O6O+WCmVdrGXt08mDOOO0ZK9W0/YJ/1/XepfPwoTAvagS+T6UF7MsrfH4VgVLuK6jpXcZrJOY/KMT324T/x28GfkR+rBK0uQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"go-generic\"\n        title=\"\"\n        src=\"/static/go-generic-cd179ef006978eebe920f8438c978775-acf85.png\"\n        srcset=\"/static/go-generic-cd179ef006978eebe920f8438c978775-c1418.png 210w,\n/static/go-generic-cd179ef006978eebe920f8438c978775-5d5d8.png 420w,\n/static/go-generic-cd179ef006978eebe920f8438c978775-acf85.png 840w,\n/static/go-generic-cd179ef006978eebe920f8438c978775-ba4c4.png 1167w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>看看在Go2中会不会实现。</p>\n<p>让我们继续看<code class=\"gatsby-code-text\">txbuilder.Build</code>：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/blockchain/txbuilder/txbuilder.go#L40-L79\">blockchain/txbuilder/txbuilder.go#L40-L79</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">Build</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> tx <span class=\"token operator\">*</span>types<span class=\"token punctuation\">.</span>TxData<span class=\"token punctuation\">,</span> actions <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>Action<span class=\"token punctuation\">,</span> maxTime time<span class=\"token punctuation\">.</span>Time<span class=\"token punctuation\">,</span> timeRange <span class=\"token builtin\">uint64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Template<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    builder <span class=\"token operator\">:=</span> TemplateBuilder<span class=\"token punctuation\">{</span>\n        base<span class=\"token punctuation\">:</span>      tx<span class=\"token punctuation\">,</span>\n        maxTime<span class=\"token punctuation\">:</span>   maxTime<span class=\"token punctuation\">,</span>\n        timeRange<span class=\"token punctuation\">:</span> timeRange<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Build all of the actions, updating the builder.</span>\n    <span class=\"token keyword\">var</span> errs <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">error</span>\n    <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> action <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> actions <span class=\"token punctuation\">{</span>\n        err <span class=\"token operator\">:=</span> action<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>builder<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// If there were any errors, rollback and return a composite error.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>errs<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        builder<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">WithData</span><span class=\"token punctuation\">(</span>ErrAction<span class=\"token punctuation\">,</span> <span class=\"token string\">\"actions\"</span><span class=\"token punctuation\">,</span> errs<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Build the transaction template.</span>\n    tpl<span class=\"token punctuation\">,</span> tx<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token keyword\">return</span> tpl<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>这块代码经过简化后，还是比较清楚的，基本上就是想尽办法把<code class=\"gatsby-code-text\">TemplateBuilder</code>填满。<code class=\"gatsby-code-text\">TemplateBuilder</code>是这样的：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/blockchain/txbuilder/builder.go#L17-L28\">blockchain/txbuilder/builder.go#L17-L28</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">type</span> TemplateBuilder <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    base                <span class=\"token operator\">*</span>types<span class=\"token punctuation\">.</span>TxData\n    inputs              <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>types<span class=\"token punctuation\">.</span>TxInput\n    outputs             <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>types<span class=\"token punctuation\">.</span>TxOutput\n    signingInstructions <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>SigningInstruction\n    minTime             time<span class=\"token punctuation\">.</span>Time\n    maxTime             time<span class=\"token punctuation\">.</span>Time\n    timeRange           <span class=\"token builtin\">uint64</span>\n    referenceData       <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span>\n    rollbacks           <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    callbacks           <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>可以看到有很多字段，但是只要清楚了它们的用途，我们也就清楚了交易<code class=\"gatsby-code-text\">transaction</code>是怎么回事。但是我发现一旦深入下去，很快又触及到比原的核心部分，所以就停在这里不去深究了。前面<code class=\"gatsby-code-text\">Build</code>函数里面提到的其它的方法，比如<code class=\"gatsby-code-text\">action.Build</code>等，我们也不进去了，因为它们基本上都是在想尽办法组装出最后需要的对象。</p>\n<p>到这里，我们可以认为<code class=\"gatsby-code-text\">buildSingle</code>就走完了，然后回到<code class=\"gatsby-code-text\">func (a *API) build(...)</code>，把生成的对象返回给前端。</p>\n<p>那么，这个接口<code class=\"gatsby-code-text\">/build-transaction</code>到底是做什么的呢？通过上面我分析，我们可以知道它有两个作用：</p>\n<ol>\n<li>一是检查各参数是否正确。因为用户填写的数据很多，而且里面的数据看起来专业性很强，容易出错，早点发现早点提醒</li>\n<li>二是补全一些信息，如<code class=\"gatsby-code-text\">id</code>，公钥等等，方便前端进行后面的操作</li>\n</ol>\n<p>在这个接口的分析过程中，我们还是忽略了很多内容，比如返回给客户端的那一大段JSON代码中的数据。我想这些东西还是留着我们研究到比原的核心的时候，再一起学习吧。</p>\n<h3 id=\"sign-transaction\"><a href=\"#sign-transaction\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"gatsby-code-text\">/sign-transaction</code></h3>\n<p>在前一步<code class=\"gatsby-code-text\">/build-transaction</code>成功完成以后，会进行下一步操作<code class=\"gatsby-code-text\">/sign-transaction</code>。</p>\n<p>下面是通过Chrome的开发工具捕获的内容：</p>\n<h4 id=\"提交的数据：-1\"><a href=\"#%E6%8F%90%E4%BA%A4%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%9A-1\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>提交的数据：</h4>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsxon\"><code class=\"gatsby-code-jsxon\">{\n    &quot;password&quot;: &quot;my-password&quot;,\n    &quot;transaction&quot;: {\n        &quot;raw_transaction&quot;: &quot;070100010161015f643bef0936443042ccb1e94213ed52a\n        f72488088702d88e7fc3580359a19a522ffffffffffffffffffffffffffffffffff\n        ffffffffffffffffffffffffffffff8099c4d599010001160014108c5ba0934951a\n        12755523f8a1fe42a6c24342f010002013dffffffffffffffffffffffffffffffff\n        ffffffffffffffffffffffffffffffffe8ebaabf4201160014b111c8114dc7ee020\n        50598022b46855fd482d27300013dffffffffffffffffffffffffffffffffffffff\n        ffffffffffffffffffffffffff80d4fe955701160014cd451eb3b1ab9949c9a8cdb\n        086fc78b60b444ff200&quot;,\n        &quot;signing_instructions&quot;: [{\n            &quot;position&quot;: 0,\n            &quot;witness_components&quot;: [{\n                &quot;type&quot;: &quot;raw_tx_signature&quot;,\n                &quot;quorum&quot;: 1,\n                &quot;keys&quot;: [{\n                    &quot;xpub&quot;: &quot;f98b3a39b4eef67707cac85240ef07235c990301b2e065\n                    8001545bdb7fde3a21363a23682a1dfbb727dec7565624812c314ca\n                    9f31a7f7374101e0247d05cb248&quot;,\n                    &quot;derivation_path&quot;: [&quot;010100000000000000&quot;, &quot;0100000000000000&quot;]\n                }],\n                &quot;signatures&quot;: null\n            }, {\n                &quot;type&quot;: &quot;data&quot;,\n                &quot;value&quot;: &quot;b826dcccff76d19d097ca207e053e67d67e3da3a90896ae9fa2d984c6f36d16c&quot;\n            }]\n        }],\n        &quot;allow_additional_actions&quot;: false\n    }\n}</code></pre>\n      </div>\n<p>可以看到这里提交的请求数据，与前面<code class=\"gatsby-code-text\">/build-transaction</code>相比，基本上是一样的，只是多了一个<code class=\"gatsby-code-text\">password</code>，即我们刚才在表单最后一处填写的密码。从这个接口的名字中含有<code class=\"gatsby-code-text\">sign</code>可以推测，这一步应该是与签名有关。</p>\n<h4 id=\"得到的回应\"><a href=\"#%E5%BE%97%E5%88%B0%E7%9A%84%E5%9B%9E%E5%BA%94\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>得到的回应</h4>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsxon\"><code class=\"gatsby-code-jsxon\">{\n    &quot;status&quot;: &quot;success&quot;,\n    &quot;data&quot;: {\n        &quot;transaction&quot;: {\n            &quot;raw_transaction&quot;: &quot;070100010161015f643bef0936443042ccb1e9421\n            3ed52af72488088702d88e7fc3580359a19a522ffffffffffffffffffffff\n            ffffffffffffffffffffffffffffffffffffffffff8099c4d599010001160\n            014108c5ba0934951a12755523f8a1fe42a6c24342f630240c52a057fa263\n            22a48fdd88c842cf31a84c6aec54ae2dc62554dc3c7e0216986a0a4f4a5c9\n            35a5ae6d88b4c7a4d1ca1937205f5eb23089128cc6744fbd2b88d0520b826\n            dcccff76d19d097ca207e053e67d67e3da3a90896ae9fa2d984c6f36d16c0\n            2013dffffffffffffffffffffffffffffffffffffffffffffffffffffffff\n            ffffffffe8ebaabf4201160014b111c8114dc7ee02050598022b46855fd48\n            2d27300013dffffffffffffffffffffffffffffffffffffffffffffffffff\n            ffffffffffffff80d4fe955701160014cd451eb3b1ab9949c9a8cdb086fc7\n            8b60b444ff200&quot;,\n            &quot;signing_instructions&quot;: [{\n                &quot;position&quot;: 0,\n                &quot;witness_components&quot;: [{\n                    &quot;type&quot;: &quot;raw_tx_signature&quot;,\n                    &quot;quorum&quot;: 1,\n                    &quot;keys&quot;: [{\n                        &quot;xpub&quot;: &quot;f98b3a39b4eef67707cac85240ef07235c990301\n                        b2e0658001545bdb7fde3a21363a23682a1dfbb727dec7565\n                        624812c314ca9f31a7f7374101e0247d05cb248&quot;,\n                        &quot;derivation_path&quot;: [&quot;010100000000000000&quot;, &quot;0100000000000000&quot;]\n                    }],\n                    &quot;signatures&quot;: [&quot;c52a057fa26322a48fdd88c842cf31a84c6aec\n                    54ae2dc62554dc3c7e0216986a0a4f4a5c935a5ae6d88b4c7a4d1c\n                    a1937205f5eb23089128cc6744fbd2b88d05&quot;]\n                }, {\n                    &quot;type&quot;: &quot;data&quot;,\n                    &quot;value&quot;: &quot;b826dcccff76d19d097ca207e053e67d67e3da3a90896ae9fa2d984c6f36d16c&quot;\n                }]\n            }],\n            &quot;allow_additional_actions&quot;: false\n        },\n        &quot;sign_complete&quot;: true\n    }\n}</code></pre>\n      </div>\n<p>回过来的消息也基本上跟提交的差不多，只是在成功操作后，<code class=\"gatsby-code-text\">raw_transaction</code>字段的内容也变长了，还添加上了<code class=\"gatsby-code-text\">signatures</code>字段。</p>\n<p>我们开始看代码，通过搜索<code class=\"gatsby-code-text\">/sign-transaction</code>，我们很快定位到以下代码：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/api.go#L164-L244\">api/api.go#L164-L244</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">*</span>API<span class=\"token punctuation\">)</span> <span class=\"token function\">buildHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token keyword\">if</span> a<span class=\"token punctuation\">.</span>wallet <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n        m<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sign-transaction\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">jsonHandler</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>pseudohsmSignTemplates<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>则<code class=\"gatsby-code-text\">/sign-transaction</code>对应的handler是<code class=\"gatsby-code-text\">a.pseudohsmSignTemplates</code>，让我们跟进去：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/hsm.go#L53-L63\">api/hsm.go#L53-L63</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">*</span>API<span class=\"token punctuation\">)</span> <span class=\"token function\">pseudohsmSignTemplates</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> x <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    Password <span class=\"token builtin\">string</span>             <span class=\"token string\">`json:\"password\"`</span>\n    Txs      txbuilder<span class=\"token punctuation\">.</span>Template <span class=\"token string\">`json:\"transaction\"`</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> Response <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> txbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">Sign</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>x<span class=\"token punctuation\">.</span>Txs<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">.</span>Password<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>pseudohsmSignTemplate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">WithField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"build err\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fail on sign transaction.\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">NewErrorResponse</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Sign Transaction complete.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">NewSuccessResponse</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>signResp<span class=\"token punctuation\">{</span>Tx<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>x<span class=\"token punctuation\">.</span>Txs<span class=\"token punctuation\">,</span> SignComplete<span class=\"token punctuation\">:</span> txbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">SignProgress</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>x<span class=\"token punctuation\">.</span>Txs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>可以看到这个方法内容也是比较简单的。通过调用<code class=\"gatsby-code-text\">txbuilder.Sign</code>，把前端传来的参数传进去，然后把结果返回给前端即可。那我们只需要看<code class=\"gatsby-code-text\">txbuilder.Sign</code>即可：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/blockchain/txbuilder/txbuilder.go#L82-L100\">blockchain/txbuilder/txbuilder.go#L82-L100</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">Sign</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> tpl <span class=\"token operator\">*</span>Template<span class=\"token punctuation\">,</span> auth <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> signFn SignFunc<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1. </span>\n    <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> sigInst <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> tpl<span class=\"token punctuation\">.</span>SigningInstructions <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> j<span class=\"token punctuation\">,</span> wc <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> sigInst<span class=\"token punctuation\">.</span>WitnessComponents <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">switch</span> sw <span class=\"token operator\">:=</span> wc<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token operator\">*</span>SignatureWitness<span class=\"token punctuation\">:</span>\n                err <span class=\"token operator\">:=</span> sw<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> tpl<span class=\"token punctuation\">,</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> signFn<span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">// ...</span>\n            <span class=\"token keyword\">case</span> <span class=\"token operator\">*</span>RawTxSigWitness<span class=\"token punctuation\">:</span>\n                err <span class=\"token operator\">:=</span> sw<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> tpl<span class=\"token punctuation\">,</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> signFn<span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">// ...</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 2.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">materializeWitnesses</span><span class=\"token punctuation\">(</span>tpl<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>可以看到这段代码逻辑还是比较简单：</p>\n<ol>\n<li>\n<p>第1处代码是两个大循环，基本上做了两件事：</p>\n<ol>\n<li>把用户提交上来的数据中需要签名的部分取出来，运行相关的签名函数<code class=\"gatsby-code-text\">sw.sign</code>，生成相关的签名<code class=\"gatsby-code-text\">signatures</code></li>\n<li>在<code class=\"gatsby-code-text\">raw_transaction</code>处添加了一些操作符和约束条件，把它变成了一个合约（这块还需要以后确认）</li>\n</ol>\n</li>\n<li>第2处代码如果发现前面签名过程正确，就调用<code class=\"gatsby-code-text\">materializeWitnesses</code>函数。它主要是在检查没有数据错误之后，把第1步中生成的签名<code class=\"gatsby-code-text\">signatures</code>添加到<code class=\"gatsby-code-text\">tpl</code>对象上去。</li>\n</ol>\n<p>由于<code class=\"gatsby-code-text\">sw.Sign</code>和<code class=\"gatsby-code-text\">materializeWitnesses</code>基本上都是一些算法或者合约相关的东西，我们这里就暂时忽略，以后再研究吧。</p>\n<p>这个接口<code class=\"gatsby-code-text\">/sign-transaction</code>的作用应该是对通过密码以及公钥对“交易”这个重要的操作进行验证，不然大家都能随便把别人的钱转到自己帐户里了。</p>\n<h3 id=\"submit-transaction\"><a href=\"#submit-transaction\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"gatsby-code-text\">/submit-transaction</code></h3>\n<p>当前一步<code class=\"gatsby-code-text\">/sign-transaction</code>签名成功之后，终于可以进行最后一步<code class=\"gatsby-code-text\">/submit-transaction</code>进行最终的提交了。</p>\n<p>下面是通过Chrome的开发工具捕获的内容。</p>\n<h4 id=\"请求的数据\"><a href=\"#%E8%AF%B7%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>请求的数据</h4>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsxon\"><code class=\"gatsby-code-jsxon\">{\n    &quot;raw_transaction&quot;: &quot;070100010161015f643bef0936443042ccb1e94213ed52af\n    72488088702d88e7fc3580359a19a522ffffffffffffffffffffffffffffffffffff\n    ffffffffffffffffffffffffffff8099c4d599010001160014108c5ba0934951a127\n    55523f8a1fe42a6c24342f630240c52a057fa26322a48fdd88c842cf31a84c6aec54\n    ae2dc62554dc3c7e0216986a0a4f4a5c935a5ae6d88b4c7a4d1ca1937205f5eb2308\n    9128cc6744fbd2b88d0520b826dcccff76d19d097ca207e053e67d67e3da3a90896a\n    e9fa2d984c6f36d16c02013dffffffffffffffffffffffffffffffffffffffffffff\n    ffffffffffffffffffffe8ebaabf4201160014b111c8114dc7ee02050598022b4685\n    5fd482d27300013dffffffffffffffffffffffffffffffffffffffffffffffffffff\n    ffffffffffff80d4fe955701160014cd451eb3b1ab9949c9a8cdb086fc78b60b444f\n    f200&quot;\n}</code></pre>\n      </div>\n<p>可以看到，到了这一步，提交的数据就少了，直接把前一步生成的签名后的<code class=\"gatsby-code-text\">raw_transaction</code>提交上去就行了。我想这里的内容应该已经包含了全部需要的信息，并且经过了验证，所以不需要其它数据了。</p>\n<h4 id=\"得到的回应-1\"><a href=\"#%E5%BE%97%E5%88%B0%E7%9A%84%E5%9B%9E%E5%BA%94-1\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>得到的回应</h4>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-jsxon\"><code class=\"gatsby-code-jsxon\">{\n    &quot;status&quot;: &quot;success&quot;,\n    &quot;data&quot;: {\n        &quot;tx_id&quot;: &quot;6866c1ab2bfa2468ce44451ce6af2a83f3885cdb6a1673fec94b27f338acf9c5&quot;\n    }\n}</code></pre>\n      </div>\n<p>可以看到成功提交后，会得到一个<code class=\"gatsby-code-text\">tx_id</code>，即为当前这个交易生成的唯一的id，可以用来查询。</p>\n<p>我们通过查找<code class=\"gatsby-code-text\">/submit-transaction</code>，可以在代码中找到：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/api.go#L164-L244\">api/api.go#L164-L244</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">*</span>API<span class=\"token punctuation\">)</span> <span class=\"token function\">buildHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token keyword\">if</span> a<span class=\"token punctuation\">.</span>wallet <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n        m<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/submit-transaction\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">jsonHandler</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>submit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>那么<code class=\"gatsby-code-text\">/submit-transaction</code>所对应的handler就是<code class=\"gatsby-code-text\">a.submit</code>了。我们跟进去：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/api/transact.go#L182-L191\">api/transact.go#L182-L191</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">*</span>API<span class=\"token punctuation\">)</span> <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> ins <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    Tx types<span class=\"token punctuation\">.</span>Tx <span class=\"token string\">`json:\"raw_transaction\"`</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> Response <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> txbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">FinalizeTx</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>chain<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ins<span class=\"token punctuation\">.</span>Tx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">NewErrorResponse</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">WithField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tx_id\"</span><span class=\"token punctuation\">,</span> ins<span class=\"token punctuation\">.</span>Tx<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"submit single tx\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">NewSuccessResponse</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>submitTxResp<span class=\"token punctuation\">{</span>TxID<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>ins<span class=\"token punctuation\">.</span>Tx<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>可以看到主要逻辑就是调用<code class=\"gatsby-code-text\">txbuilder.FinalizeTx</code>来“终结”这个交易，然后把生成的<code class=\"gatsby-code-text\">tx_id</code>返回给前端。</p>\n<p>让我们继续看<code class=\"gatsby-code-text\">txbuilder.FinalizeTx</code>：</p>\n<p><a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/blockchain/txbuilder/finalize.go#L25-L47\">blockchain/txbuilder/finalize.go#L25-L47</a></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"gatsby-code-go\"><code class=\"gatsby-code-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">FinalizeTx</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> c <span class=\"token operator\">*</span>protocol<span class=\"token punctuation\">.</span>Chain<span class=\"token punctuation\">,</span> tx <span class=\"token operator\">*</span>types<span class=\"token punctuation\">.</span>Tx<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1.</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">checkTxSighashCommitment</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> err\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// This part is use for prevent tx size  is 0</span>\n    <span class=\"token comment\">// 2.</span>\n    data<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> tx<span class=\"token punctuation\">.</span>TxData<span class=\"token punctuation\">.</span><span class=\"token function\">MarshalText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n    \n    <span class=\"token comment\">// 3.</span>\n    tx<span class=\"token punctuation\">.</span>TxData<span class=\"token punctuation\">.</span>SerializedSize <span class=\"token operator\">=</span> <span class=\"token function\">uint64</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    tx<span class=\"token punctuation\">.</span>Tx<span class=\"token punctuation\">.</span>SerializedSize <span class=\"token operator\">=</span> <span class=\"token function\">uint64</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 4.</span>\n    <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">ValidateTx</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>这一个方法整体上还是各种验证</p>\n<ol>\n<li>第1处代码是对交易对象签名相关的内容进行严格的检查，比如参数个数、签名、甚至某些对应虚拟机的操作码，这一块挺复杂的，你一定不会想看<a href=\"https://github.com/freewind/bytom-v1.0.1/blob/master/blockchain/txbuilder/finalize.go#L66-L113\">blockchain/txbuilder/finalize.go#L66-L113</a></li>\n<li>第2处代码是把交易数据解码，从看起来奇怪的16进制字符串变成正常的内容</li>\n<li>第3处代码是把解析出来的内容的长度赋值给<code class=\"gatsby-code-text\">tx</code>中的某些字段</li>\n<li>第4处代码是对交易内容再次进行详细的检查，最后还包括了对gas的检查，如果全部正常，则会把它提交到<code class=\"gatsby-code-text\">txPool</code>（用来在内存中保存交易的对象池），等待广播出去以及打包到区块中。我觉得这个名字<code class=\"gatsby-code-text\">ValidateTx</code>有点问题，因为它即包含了验证，还包含了提交到池子中，这是两个不同的操作，应该分开</li>\n</ol>\n<p>这里涉及到的更细节的代码就不进去了，主线我们已经有了，感兴趣的同学可以自行进去深入研究。</p>\n<p>那我们今天关于提交交易的这个小问题就算是完成了，下次会继续研究剩下的几个小问题。</p>\n<hr>\n<p>如果你觉得这些文章对你非常有用，控制不住想打赏作者，可以有以下选择：</p>\n<ol>\n<li>BTM: <code class=\"gatsby-code-text\">0x6bcCfb7265d4aB0C1a71F7d19b9E581cae73D777</code></li>\n<li>BTC: <code class=\"gatsby-code-text\">1Af2Q23Y1kqgtgbryzjS7RxrnEmyvYuX4b</code></li>\n<li>ETH: <code class=\"gatsby-code-text\">0x6bcCfb7265d4aB0C1a71F7d19b9E581cae73D777</code></li>\n</ol>\n<p>多少请随意，心意最重要，我们一起努力吧！</p>","frontmatter":{"title":"如何转帐","next":null,"prev":null},"fields":{"path":null,"slug":"docs/bytomanalysis-transfer.html"}}},"pathContext":{"slug":"docs/bytomanalysis-transfer.html"}}